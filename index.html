<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Car Agent AI - ìë™ì°¨ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸</title>

    <meta name="description" content="Car Agent AI - ìë™ì°¨ì— ê´€í•œ ëª¨ë“  ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”. ìœ ì§€ë¹„ ê³„ì‚°, ì°¨ëŸ‰ ì¶”ì²œ, ì¤‘ê³ ì°¨ ì‹œì„¸, ì •ë¹„ ì •ë³´ê¹Œì§€ AIê°€ ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤.">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e3a8a;
            --primary-blue-light: #3b82f6;
            --primary-blue-lighter: #60a5fa;
            --bg-blue: #f0f9ff;
            --bg-blue-light: #e0f2fe;
            --border-blue: #bfdbfe;
            --success-green: #10b981;
            --text-dark: #1e293b;
            --text-gray: #64748b;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” */
        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .logo-icon {
            font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
        }

        .nav-menu {
            display: flex;
            gap: 16px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-btn:hover {
            background: var(--bg-blue);
            color: var(--primary-blue);
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 24px;
            gap: 20px;
        }

        /* ì±„íŒ… ì»¨í…Œì´ë„ˆ */
        .chat-container {
            flex: 1;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 600px;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px 24px;
            background: linear-gradient(to bottom, #fafbff 0%, #ffffff 100%);
        }

        /* ì›°ì»´ ì„¹ì…˜ */
        .welcome-section {
            text-align: center;
            padding: 40px 20px;
            animation: fadeIn 0.6s ease-out;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-gray);
            margin-bottom: 32px;
        }

        /* ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ */
        .example-prompts {
            margin-top: 40px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
            background: rgba(255, 255, 255, 0.5);
            padding: 24px 32px;
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .example-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 12px;
        }

        .example-item {
            font-size: 15px;
            color: var(--text-primary);
            line-height: 2;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .example-item:hover {
            opacity: 1;
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            margin-bottom: 24px;
            animation: fadeInUp 0.4s ease-out;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.bot {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .bot-avatar {
            font-size: 32px;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.2));
        }

        .message-bubble {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }

        .message.bot .message-bubble {
            background: linear-gradient(135deg, var(--bg-blue) 0%, var(--bg-blue-light) 100%);
            color: var(--text-dark);
            border: 1px solid var(--border-blue);
            border-radius: 16px 16px 16px 4px;
        }

        /* ë©”ì‹œì§€ ë‚´ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
        .message-bubble h1,
        .message-bubble h2,
        .message-bubble h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .message-bubble h1 {
            font-size: 20px;
            border-bottom: 2px solid var(--border-blue);
            padding-bottom: 8px;
        }

        .message-bubble h2 {
            font-size: 18px;
        }

        .message-bubble h3 {
            font-size: 16px;
        }

        .message-bubble h1:first-child,
        .message-bubble h2:first-child,
        .message-bubble h3:first-child {
            margin-top: 0;
        }

        .message-bubble strong {
            font-weight: 700;
            color: var(--primary-blue);
        }

        .message-bubble ul,
        .message-bubble ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-bubble li {
            margin: 6px 0;
            line-height: 1.7;
        }

        .message-bubble p {
            margin: 8px 0;
            line-height: 1.7;
        }

        .message-bubble code {
            background: rgba(30, 58, 138, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: var(--primary-blue);
        }

        .message-bubble pre {
            background: rgba(30, 58, 138, 0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border-left: 3px solid var(--primary-blue-light);
        }

        .message-bubble pre code {
            background: none;
            padding: 0;
        }

        .message-bubble blockquote {
            border-left: 4px solid var(--primary-blue-light);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-gray);
            font-style: italic;
        }

        .message-bubble hr {
            border: none;
            border-top: 1px solid var(--border-blue);
            margin: 16px 0;
        }

        .message-bubble a {
            color: var(--primary-blue-light);
            text-decoration: none;
            font-weight: 500;
        }

        .message-bubble a:hover {
            text-decoration: underline;
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            display: inline-flex;
            gap: 5px;
            padding: 12px 18px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-blue-light);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-container {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-blue);
            border-radius: 16px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            background: var(--bg-blue);
            font-family: inherit;
            resize: none;
            min-height: 52px;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: var(--primary-blue-light);
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ìƒíƒœ ì¸ë””ì¼€ì´í„° */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-gray);
            padding: 6px 12px;
            background: var(--bg-blue);
            border-radius: 20px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--success-green);
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }

            .logo {
                font-size: 18px;
            }

            .main-container {
                padding: 12px;
            }

            .chat-container {
                min-height: calc(100vh - 100px);
                border-radius: 20px;
            }

            .welcome-title {
                font-size: 28px;
            }

            .example-prompts {
                padding: 20px 24px;
            }

            .message-bubble {
                max-width: 85%;
            }

            .nav-menu {
                gap: 8px;
            }

            .nav-btn {
                font-size: 13px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <div class="logo" onclick="resetToHome()" style="cursor: pointer;">
            <span class="logo-icon">ğŸ¤–</span>
            <span>Car Agent AI</span>
        </div>
        <div class="nav-menu">
            <div class="status-indicator">
                <span class="status-dot"></span>
                ì˜¨ë¼ì¸
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <div class="chat-container">
            <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
            <div class="chat-messages" id="chatMessages">
                <!-- ì›°ì»´ ì„¹ì…˜ -->
                <div class="welcome-section" id="welcomeSection">
                    <div class="welcome-title">
                        <span>ğŸš—</span>
                        ì°¨ëŸ‰ì— ê´€í•œ ëª¨ë“  ê²ƒ, AIì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”
                    </div>
                    <div class="welcome-subtitle">
                        ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ë¡œ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”
                    </div>

                    <!-- ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ -->
                    <div class="example-prompts">
                        <div class="example-label">ì˜ˆë¥¼ ë“¤ì–´:</div>
                        <div class="example-item">â€¢ "BMW 520d 2020ë…„ì‹ ìœ ì§€ë¹„ ì•Œë ¤ì¤˜"</div>
                        <div class="example-item">â€¢ "ë²¨ë¡œìŠ¤í„° 2019 ì¤‘ê³ ì°¨ ì‹œì„¸ëŠ”?"</div>
                        <div class="example-item">â€¢ "ì•„ë°˜ë–¼ CN7 ì›” ìœ ì§€ë¹„ ì–¼ë§ˆì•¼?"</div>
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea
                        class="chat-input"
                        id="chatInput"
                        placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
                        rows="1"
                    ></textarea>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    â¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // ë²„ì „ í™•ì¸ (ìºì‹œ ë””ë²„ê¹…ìš©)
        console.log('ğŸš€ Car Agent v2.2 - ì˜µì…˜2 ì ìš© (í€µì•¡ì…˜ ì œê±°, ì˜ˆì‹œ í…ìŠ¤íŠ¸)');
        console.log('ë¡œë“œ ì‹œê°„:', new Date().toLocaleTimeString());

        // ì„¸ì…˜ ID ìƒì„±
        let sessionId = localStorage.getItem('car_agent_session');
        if (!sessionId) {
            sessionId = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
            localStorage.setItem('car_agent_session', sessionId);
        }

        // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ ë†’ì´ ì¡°ì ˆ
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // í™ˆ í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹
        function resetToHome() {
            const chatMessages = document.getElementById('chatMessages');

            // ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œí•˜ê³  ì›°ì»´ ì„¹ì…˜ë§Œ ë‚¨ê¸°ê¸°
            chatMessages.innerHTML = `
                <div class="welcome-section" id="welcomeSection">
                    <div class="welcome-title">
                        <span>ğŸš—</span>
                        ì°¨ëŸ‰ì— ê´€í•œ ëª¨ë“  ê²ƒ, AIì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”
                    </div>
                    <div class="welcome-subtitle">
                        ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ë¡œ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”
                    </div>

                    <!-- ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ -->
                    <div class="example-prompts">
                        <div class="example-label">ì˜ˆë¥¼ ë“¤ì–´:</div>
                        <div class="example-item">â€¢ "BMW 520d 2020ë…„ì‹ ìœ ì§€ë¹„ ì•Œë ¤ì¤˜"</div>
                        <div class="example-item">â€¢ "ë²¨ë¡œìŠ¤í„° 2019 ì¤‘ê³ ì°¨ ì‹œì„¸ëŠ”?"</div>
                        <div class="example-item">â€¢ "ì•„ë°˜ë–¼ CN7 ì›” ìœ ì§€ë¹„ ì–¼ë§ˆì•¼?"</div>
                    </div>
                </div>
            `;

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // ì›°ì»´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            const typingId = addTypingIndicator();

            try {
                // n8n ì›¹í›…ìœ¼ë¡œ ì „ì†¡
                const response = await fetch('https://bot.hopto.org/webhook/1217a495-1bb2-4a90-a56c-4497f248c1ec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId,
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                // ë””ë²„ê¹…ìš© ë¡œê·¸
                console.log('ë°›ì€ ë°ì´í„°:', data);

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
                removeTypingIndicator(typingId);

                // ì‘ë‹µ ì²˜ë¦¬: JSON êµ¬ì¡°í™” ë°ì´í„° ë˜ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸
                if (data.output) {
                    // AI Agent ì‘ë‹µ (output í•„ë“œ)
                    addMessage(data.output, 'bot');
                } else if (data.reply) {
                    // replyê°€ ë¬¸ìì—´ì¸ ê²½ìš°
                    if (typeof data.reply === 'string') {
                        try {
                            // JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸ ('{' ë¡œ ì‹œì‘í•˜ë©´ JSON)
                            if (data.reply.trim().startsWith('{')) {
                                const parsedData = JSON.parse(data.reply);
                                if (parsedData.calculated) {
                                    // ìœ ì§€ë¹„ ê³„ì‚° ê²°ê³¼
                                    const formattedReply = formatMaintenanceData(parsedData);
                                    addMessage(formattedReply, 'bot');
                                } else {
                                    // ë‹¤ë¥¸ êµ¬ì¡°í™”ëœ ë°ì´í„°
                                    addMessage(data.reply, 'bot');
                                }
                            } else {
                                // ì¼ë°˜ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸
                                addMessage(data.reply, 'bot');
                            }
                        } catch (e) {
                            // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                            addMessage(data.reply, 'bot');
                        }
                    } else {
                        // replyê°€ ê°ì²´ì¸ ê²½ìš°
                        if (data.reply.calculated) {
                            const formattedReply = formatMaintenanceData(data.reply);
                            addMessage(formattedReply, 'bot');
                        } else {
                            addMessage(JSON.stringify(data.reply), 'bot');
                        }
                    }
                } else if (data.calculated) {
                    // ìœ ì§€ë¹„ ê³„ì‚° ê²°ê³¼ (êµ¬ì¡°í™”ëœ JSON)
                    const formattedReply = formatMaintenanceData(data);
                    addMessage(formattedReply, 'bot');
                } else if (Array.isArray(data) && data.length > 0) {
                    // ë°°ì—´ë¡œ ê°ì‹¸ì§„ ê²½ìš° ì²˜ë¦¬
                    const firstItem = data[0];
                    if (firstItem.calculated) {
                        const formattedReply = formatMaintenanceData(firstItem);
                        addMessage(formattedReply, 'bot');
                    } else if (firstItem.output) {
                        addMessage(firstItem.output, 'bot');
                    } else {
                        addMessage(JSON.stringify(data), 'bot');
                    }
                } else {
                    addMessage('ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'bot');
                }

            } catch (error) {
                console.error('ì±„íŒ… ì˜¤ë¥˜:', error);
                removeTypingIndicator(typingId);
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot');
            }
        }

        // ìœ ì§€ë¹„ ë°ì´í„°ë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ í¬ë§·íŒ…
        function formatMaintenanceData(data) {
            const fmt = (num) => num.toLocaleString('ko-KR');

            let md = `## ğŸš— ${data.specs.model_name}\n\n`;

            // ì£¼ì˜ ë©”ì‹œì§€ (ìˆëŠ” ê²½ìš°)
            if (data.notice_message) {
                md += `${data.notice_message}\n\n`;
            }

            // ì›” ìœ ì§€ë¹„
            md += `### ğŸ’° ì›” ì˜ˆìƒ ìœ ì§€ë¹„\n`;
            md += `**${fmt(data.calculated.total_monthly)}ì›**\n\n`;

            // ì—°ê°„ ë¹„ìš© ìƒì„¸
            md += `### ğŸ“Š ì—°ê°„ ë¹„ìš© ìƒì„¸\n`;
            md += `* **ìë™ì°¨ì„¸**: ${fmt(data.yearly_costs.tax)}ì›\n`;
            md += `* **ë³´í—˜ë£Œ**: ${fmt(data.yearly_costs.insurance)}ì›\n`;
            md += `* **ì—°ë£Œë¹„** (ì—° 12,000km): ${fmt(data.yearly_costs.fuel_20k)}ì›\n`;
            md += `* **ì •ë¹„ ì˜ˆë¹„ë¹„**: ${fmt(data.yearly_costs.repair_fund)}ì›\n\n`;

            // ì°¨ëŸ‰ ì œì›
            md += `### ğŸ”§ ì°¨ëŸ‰ ì œì›\n`;
            md += `* **ë°°ê¸°ëŸ‰**: ${fmt(data.specs.engine_cc)}cc\n`;
            md += `* **ì—°ë¹„**: ${data.specs.fuel_eff}km/L\n`;
            md += `* **ì—°ë£Œ ì¢…ë¥˜**: ${data.specs.fuel_grade} (${data.specs.fuel_type})\n`;
            md += `* **ì°¨ëŸ‰ ì‹œì„¸**: ${fmt(data.specs.market_price)}ì›\n\n`;

            // ì£¼ìš” ì†Œëª¨í’ˆ
            if (data.maintenance_items && data.maintenance_items.length > 0) {
                md += `### ğŸ”© ì£¼ìš” ì†Œëª¨í’ˆ êµì²´ ë¹„ìš©\n`;
                data.maintenance_items.forEach(item => {
                    md += `* **${item.part}**: ${fmt(item.cost)}ì› (${item.cycle})\n`;
                });
                md += `\n`;
            }

            // ê³ ì§ˆë³‘ ì •ë³´
            if (data.risk_report) {
                md += `### âš ï¸ ê³ ì§ˆë³‘ ì •ë³´\n`;
                md += `${data.risk_report}\n\n`;
            }

            // ì¢…í•© ì˜ê²¬
            if (data.total_comment) {
                md += `### ğŸ’¡ ì¢…í•© ì˜ê²¬\n`;
                md += `${data.total_comment}\n\n`;
            }

            // ì™¸ë¶€ ë§í¬
            if (data.external_links) {
                md += `### ğŸ”— ìœ ìš©í•œ ë§í¬\n`;
                md += `* [ì¤‘ê³ ì°¨ ì‹œì„¸ í™•ì¸](${data.external_links.used_market})\n`;
                md += `* [ìœ íŠœë¸Œ ì‹œìŠ¹ê¸°](${data.external_links.youtube_review})\n`;
                md += `* [ì´ë¯¸ì§€ ê²€ìƒ‰](${data.external_links.image_search})\n`;
            }

            return md;
        }

        // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ íŒŒì„œ
        function parseMarkdown(text) {
            // ì¤„ë°”ê¿ˆì„ ë³´ì¡´í•˜ë©´ì„œ ì²˜ë¦¬
            let html = text;

            // ì½”ë“œ ë¸”ë¡ (```)
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // ì¸ë¼ì¸ ì½”ë“œ (`)
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // ë³¼ë“œ (**)
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');

            // í—¤ë”© ì²˜ë¦¬
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (ìˆœì„œ ì—†ëŠ” ë¦¬ìŠ¤íŠ¸)
            html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (ìˆœì„œ ìˆëŠ” ë¦¬ìŠ¤íŠ¸)
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            // ë§í¬ [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // êµ¬ë¶„ì„ 
            html = html.replace(/^---$/gm, '<hr>');

            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // ë¹ˆ p íƒœê·¸ ì œê±°
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[123]>)/g, '$1');
            html = html.replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');

            return html;
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            // ë´‡ ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
            const content = sender === 'bot' ? parseMarkdown(text) : text;

            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="bot-avatar">ğŸ¤–</div>
                    <div class="message-bubble">${content}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-bubble">${content}</div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingId = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.id = typingId;
            typingDiv.className = 'message bot';
            typingDiv.innerHTML = `
                <div class="bot-avatar">ğŸ¤–</div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return typingId;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
        function removeTypingIndicator(id) {
            const typingElement = document.getElementById(id);
            if (typingElement) {
                typingElement.remove();
            }
        }
    </script>
</body>
</html>
